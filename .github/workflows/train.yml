name: Model Training Pipeline

on:
  # 수동 실행 (워크플로우 디스패치)
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of epochs'
        required: true
        default: '5'
      batch_size:
        description: 'Batch size'
        required: true
        default: '64'
      learning_rate:
        description: 'Learning rate'
        required: true
        default: '0.001'
  
  # 스케줄 실행 (매주 월요일 00:00 UTC)
  schedule:
    - cron: '0 0 * * 1'

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Train model
        run: |
          cd src
          python train.py \
            --epochs ${{ github.event.inputs.epochs || '5' }} \
            --batch-size ${{ github.event.inputs.batch_size || '64' }} \
            --lr ${{ github.event.inputs.learning_rate || '0.001' }} \
            --experiment-name "github-actions-training"
      
      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model-${{ github.run_number }}
          path: models/
          retention-days: 30
      
      - name: Upload MLflow logs
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-logs-${{ github.run_number }}
          path: src/mlruns/
          retention-days: 14

  # 모델 평가 및 레지스트리 등록
  evaluate:
    runs-on: ubuntu-latest
    needs: train
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model-${{ github.run_number }}
          path: models/
      
      - name: Evaluate model
        run: |
          cd src
          python evaluate.py --model-path ../models/best_model.pth
      
      - name: Check model quality gate
        run: |
          # 모델 정확도가 95% 이상인지 확인
          ACCURACY=$(cat models/evaluation_results.json | python -c "import sys, json; print(json.load(sys.stdin)['accuracy'])")
          echo "Model accuracy: $ACCURACY%"
          if (( $(echo "$ACCURACY < 95" | bc -l) )); then
            echo "❌ Model accuracy below threshold (95%)"
            exit 1
          fi
          echo "✅ Model passed quality gate!"
